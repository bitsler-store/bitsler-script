<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Download Your File</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="box">
  <h2>üì• Download</h2>
  <p id="msg">Verifying your order...</p>
  <a id="fileLink" href="#" style="display:none;" download>Download File</a>
</div>

<script>
const WORKER_URL = "https://crypto-backend.bijamalala.workers.dev";
const params = new URLSearchParams(window.location.search);
const orderId = params.get("orderId");

async function verifyOrder(){
  try{
    // R√©cup√©rer l'ordre depuis worker
    const resp = await fetch(`${WORKER_URL}/get-order?orderId=${orderId}`);
    if(!resp.ok) throw "Order not found or expired";
    const order = await resp.json();

    if(order.status !== "paid"){
      document.getElementById("msg").innerText = "Payment not confirmed yet.";
      return;
    }

    // Anti-double download
    if(order.downloaded){
      document.getElementById("msg").innerText = "File already downloaded on another device or IP.";
      return;
    }

    // G√©n√©rer lien unique
    const link = "fichier.txt"; // ton fichier r√©el
    document.getElementById("fileLink").href = link;
    document.getElementById("fileLink").style.display = "inline-block";
    document.getElementById("msg").innerText = "Click the button to download your file.";

    // Marquer comme t√©l√©charg√©
    await fetch(`${WORKER_URL}/update-order`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ orderId })
    });

  }catch(e){
    document.getElementById("msg").innerText = "Error verifying order or link expired.";
  }
}

verifyOrder();
</script>
</body>
</html>
